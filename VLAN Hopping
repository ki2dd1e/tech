Атака VLAN Hopping используется для перехода в другие VLAN сети.
Есть 2 типа такой атаки: спуфинг и двойное тегирование.
Тип "Спуфинг" позволяет атакующему инициализировать trunk соединение с коммутатором, что возможно, если интерфейс коммутатора имеет включенный DTP протокол (на Cisco - режим dynamic desirable). Протокол DTP служит для динамического создания trunk соединений между сетевыми устройствами.
Тип "Двойное тегирование" также требует подключения к trunk порту. Злоумышленник тегирует отправляемые пакеты дважды, благодаря чему коммутатор, при получении этого пакета и отправкой на access порт, снимет только 1 тег, а второй оставит нетронутым. Очевидно, снимаемый тег должен быть связан с VLAN атакующего, внутренний - с VLAN жертвы.
Простендируем оба типа атаки. Пусть есть 2 подсети VLAN 1 и VLAN 2, разделенных коммутатором. Злоумышленник находится в VLAN 1, подключенный к Ethernet 0/1 коммутатора и пытается установить связь с хостом из VLAN 2. На данном порте настроен DTP:
```
Switch#show interfaces Ethernet 0/1 switchport
Name: Et0/1
Switchport: Enabled
Administrative Mode: dynamic desirable
Operational Mode: trunk
Administrative Trunking Encapsulation: negotiate
Operational Trunking Encapsulation: dot1q
Negotiation of Trunking: On
```
Изменить его (из интереса к кибербезопасности) можно командой Cisco в конфиге интерфейса: switchport mode dynamic desirable.
Общая схема сети следующая:
![alt text](https://github.com/ki2dd1e/tech/blob/main/image.png)
IP адрес злоумышленника: 1.1.1.2, VLAN ID 1.
IP адрес жертвы: 2.2.2.2, VLAN ID 2.
На данный момент интерфейсы настроены следующим образом:
```
Switch#show interfaces status

Port      Name               Status       Vlan       Duplex  Speed Type
Et0/0                        connected    1          a-full   auto RJ45
Et0/1                        connected    1          a-full   auto RJ45
Et0/2                        connected    2          a-full   auto RJ45
...
```
На хосте злоумышленника запустим ПО yersinia (сломавшая не одну зависимость) и выберем DTP -> Launch attack -> enable trunking.
В консоли коммутатора теперь видно, что интерфейс Eth0/1 изменен на Trunk:
```
Et0/1                        connected    trunk          a-full   auto RJ45
```
Остается добавить виртуальный интерфейс и назначить ему IP из VLAN 2:
```
modprobe 8021q
vconfig add eth0 2
ifconfig eth0.2 up
ifconfig eth0.2 2.2.2.3 up
```
В результате, пинг от злоумышленника до хоста из VLAN 2 проходит успешно, и тем самым выполнена атака VLAN Hopping.
Для устранения угроз необходимо вынести все неиспользуемые порты коммутатора в отдельный VLAN со специальным ID (номер которого тяжело выбрать случайно), а также отключить DTP.
Примечание:
При включенном DTP протоколе один из коммутаторов отправляет DTP сообщение с указанием своего MAC адреса (поле Neighbor MAC-address) и режима соединения (DTP Type), а в MAC адрес получателя записывает мультикаст адрес, после чего ждет ответ. Фактически, DTP инкапсулирован в Ethernet фрейм, а поэтому поля DTP можно легко добавить вручную; иными словами, чтобы не быть привязанными к одному ПО в виде yersinia, воспользуемся PackEth.
<добавить сборку фрейма DTP>.
